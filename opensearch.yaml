apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
data:
  fluent-bit.conf: |
    [SERVICE]
        flush        1
        daemon       Off
        log_level    trace # error, warning, info, debug, trace
        parsers_file parsers.conf
        plugins_file plugins.conf
        http_server  Off
        http_listen  0.0.0.0
        http_port    2020
        storage.metrics on # /api/v1/storage
        # storage.path /tmp/storage
        # storage.sync normal
        # storage.checksum off
        # storage.backlog.mem_limit 5M
        scheduler.base 3
        scheduler.cap  12

    [INPUT]
        name   tcp
        listen 0.0.0.0
        port   5170
        format json

    [OUTPUT]
        name  stdout
        match *

    [OUTPUT]
        name  es
        match *
        host  192.168.2.3
        port  9200
        index my_index
        type  my_type
        retry_limit 1
        storage.total_limit_size 1KB
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-deploy
  labels:
    name: app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: app # == pod template: labels
  template:
    metadata:
      labels:
        app: app
    spec:
      containers:
        - name: fluent-bit
          image: fluent/fluent-bit:3.1.9-debug
          ports:
            - containerPort: 5170
          volumeMounts:
            - name: fluent-bit-config
              mountPath: /fluent-bit/etc/fluent-bit.conf
              subPath: fluent-bit.conf
              readOnly: true
      volumes:
        - name: fluent-bit-config
          configMap:
            name: fluent-bit-config
---
apiVersion: v1
kind: Service
metadata:
  name: app-service
spec:
  type: NodePort # or ClusterIP
  selector:
    app: app # == pod template: labels
  ports:
    - protocol: TCP
      name: fluent-tcp
      port: 5170
      targetPort: 5170 # == pod template: spec ports container port
      nodePort: 30170

